{"_path":"/articles/maintain-statistics-about-your-database-tables-using-laravel-and-triggers","_draft":false,"_partial":false,"_locale":"en","_empty":false,"title":"Articles - Maintain statistics about your database tables using Laravel and triggers","description":"A couple of weeks ago, I was tackling an issue with a database query that wasn’t performing very well. While indexing helped, having to count millions of records is always going to be slow. I therefore decided to use another approach.","excerpt":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"maintain-statistics-about-your-database-tables-using-laravel-and-triggers"},"children":[{"type":"text","value":"Maintain statistics about your database tables using Laravel and triggers"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"span","props":{"className":["meta"]},"children":[{"type":"text","value":"8th February 2022"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"A couple of weeks ago, I was tackling an issue with a database query that wasn’t performing very well. The problem stemmed from attempting to do a count on a large number of records. While indexing helped, having to count millions of records is always going to be slow. I therefore decided that using a statistics table and maintaining the current count would be a better approach."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"getting-started"},"children":[{"type":"text","value":"Getting started"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"As you might expect within a Laravel application, I first created a "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"statistics"}]},{"type":"text","value":" table that had a table "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"name"}]},{"type":"text","value":" column and a "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"JSON"}]},{"type":"text","value":" values column. Next, I had to write the code to create statistic records and maintain them."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"One approach for this, is to use model events. These are fired automatically by Laravel when a model is created, deleted etc. However, while they are very powerful and definitely have their uses, there are some major drawbacks to trying to maintain statistics by using them:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Model events are only fired on model instances. So, if you run a database query to, say mass-delete some records, then no events will be fired."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Maintaining statistics within your app means that any database activity MUST go through your app. If you delete a record using a tool like TablePlus or Sequel Ace, then your stats won’t get updated."}]}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"triggers-to-the-rescue"},"children":[{"type":"text","value":"Triggers to the rescue"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Database triggers are a lot like model events, except they are physically wired into the database itself, which means that they are fired no matter what app, tool or person is responsible for altering the database state (whether it is one record you’re working with or one thousand)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Of course, since they are part of the database itself, the code statements that they execute must be pure SQL. This can make for a less than ideal developer experience, particularly if you’re not great when it comes to writing SQL, but for what I wanted to do, I knew it wouldn’t be too complicated."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"adding-trigger-support-to-laravel"},"children":[{"type":"text","value":"Adding trigger support to Laravel"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Out of the box, triggers are not supported in Laravel, so I had to first build a package that would allow me to easily add triggers to any table I wanted. This package is "},{"type":"element","tag":"a","props":{"href":"https://github.com/caneara/triggers","rel":["nofollow"]},"children":[{"type":"text","value":"available here"}]},{"type":"text","value":" and includes full documentation."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If you’ve worked with model events before (or used "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"Observer"}]},{"type":"text","value":" classes), then it should feel extremely familiar. The only downside, as mentioned above, is that you need to write raw SQL to make them work. As Laravel developers, we like to abstract such logic behind a friendly API..."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"easily-add-and-maintain-statistics"},"children":[{"type":"text","value":"Easily add and maintain statistics"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now that triggers can be added, and I have my statistics table, all I needed to do was add some helpful methods to create the triggers and aggregate column values. Given that triggers require their database table to already exist, I think it makes sense to start the statistic creation process from the Model class e.g."}]},{"type":"element","tag":"code","props":{"code":"Article::track()\n","language":"php"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"Article::track()\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Next, we want to be able to maintain the statistics themselves. We’ll therefore need methods that correspond to SQL aggregation methods e.g. "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"COUNT"}]},{"type":"text","value":", "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"MAX"}]},{"type":"text","value":", "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"MIN"}]},{"type":"text","value":", "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"SUM"}]},{"type":"text","value":", "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"AVG"}]},{"type":"text","value":":"}]},{"type":"element","tag":"code","props":{"code":"Article::track()\n    ->count()      // Count all records\n    ->sum('likes') // Get the sum of the 'likes' column\n","language":"php"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"Article::track()\n    ->count()      // Count all records\n    ->sum('likes') // Get the sum of the 'likes' column\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Finally, we just need to instruct Laravel to go ahead and create an empty statistic record, as well as install the triggers:"}]},{"type":"element","tag":"code","props":{"code":"Article::track()\n    ->count()\n    ->sum('likes')\n    ->create()\n","language":"php"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"Article::track()\n    ->count()\n    ->sum('likes')\n    ->create()\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"And that’s all there is to it. Accurate aggregations that are constantly kept in sync without any ongoing application logic being needed!"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"You can starting using "},{"type":"element","tag":"a","props":{"href":"https://github.com/caneara/statistics","rel":["nofollow"]},"children":[{"type":"text","value":"this package"}]},{"type":"text","value":" right away in your own apps and it also includes further documentation to explain how it works."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When you’re ready to start adding further triggers, e.g. for maintaining statistics on individual records ("},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"article -> likes, views, comments"}]},{"type":"text","value":" etc.) why not dive into the source to see how its done."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"wrapping-up"},"children":[{"type":"text","value":"Wrapping Up"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I hope you enjoyed this article and that you found something interesting in it. If you’d like to see more from me, then you can follow me on Twitter."}]}]},"date":"8th February 2022","image":{"src":"/assets/images/2.setting-up-an-s3-bucket-and-cloudfront-distribution-for-a-laravel-vapor-storage-disk.jpg"},"head":{"meta":[{"property":"og:title","content":"Maintain statistics about your database tables using Laravel and triggers"},{"property":"og:description","content":"A couple of weeks ago, I was tackling an issue with a database query that wasn’t performing very well. While indexing helped, having to count millions of records is always going to be slow. I therefore decided to use another approach."}]},"body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"maintain-statistics-about-your-database-tables-using-laravel-and-triggers"},"children":[{"type":"text","value":"Maintain statistics about your database tables using Laravel and triggers"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"span","props":{"className":["meta"]},"children":[{"type":"text","value":"8th February 2022"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"A couple of weeks ago, I was tackling an issue with a database query that wasn’t performing very well. The problem stemmed from attempting to do a count on a large number of records. While indexing helped, having to count millions of records is always going to be slow. I therefore decided that using a statistics table and maintaining the current count would be a better approach."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"getting-started"},"children":[{"type":"text","value":"Getting started"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"As you might expect within a Laravel application, I first created a "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"statistics"}]},{"type":"text","value":" table that had a table "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"name"}]},{"type":"text","value":" column and a "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"JSON"}]},{"type":"text","value":" values column. Next, I had to write the code to create statistic records and maintain them."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"One approach for this, is to use model events. These are fired automatically by Laravel when a model is created, deleted etc. However, while they are very powerful and definitely have their uses, there are some major drawbacks to trying to maintain statistics by using them:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Model events are only fired on model instances. So, if you run a database query to, say mass-delete some records, then no events will be fired."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Maintaining statistics within your app means that any database activity MUST go through your app. If you delete a record using a tool like TablePlus or Sequel Ace, then your stats won’t get updated."}]}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"triggers-to-the-rescue"},"children":[{"type":"text","value":"Triggers to the rescue"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Database triggers are a lot like model events, except they are physically wired into the database itself, which means that they are fired no matter what app, tool or person is responsible for altering the database state (whether it is one record you’re working with or one thousand)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Of course, since they are part of the database itself, the code statements that they execute must be pure SQL. This can make for a less than ideal developer experience, particularly if you’re not great when it comes to writing SQL, but for what I wanted to do, I knew it wouldn’t be too complicated."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"adding-trigger-support-to-laravel"},"children":[{"type":"text","value":"Adding trigger support to Laravel"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Out of the box, triggers are not supported in Laravel, so I had to first build a package that would allow me to easily add triggers to any table I wanted. This package is "},{"type":"element","tag":"a","props":{"href":"https://github.com/caneara/triggers","rel":["nofollow"]},"children":[{"type":"text","value":"available here"}]},{"type":"text","value":" and includes full documentation."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If you’ve worked with model events before (or used "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"Observer"}]},{"type":"text","value":" classes), then it should feel extremely familiar. The only downside, as mentioned above, is that you need to write raw SQL to make them work. As Laravel developers, we like to abstract such logic behind a friendly API..."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"easily-add-and-maintain-statistics"},"children":[{"type":"text","value":"Easily add and maintain statistics"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now that triggers can be added, and I have my statistics table, all I needed to do was add some helpful methods to create the triggers and aggregate column values. Given that triggers require their database table to already exist, I think it makes sense to start the statistic creation process from the Model class e.g."}]},{"type":"element","tag":"code","props":{"code":"Article::track()\n","language":"php"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-35a0ab"},"children":[{"type":"text","value":"Article"}]},{"type":"element","tag":"span","props":{"class":"ct-5af895"},"children":[{"type":"text","value":"::"}]},{"type":"element","tag":"span","props":{"class":"ct-0c2924"},"children":[{"type":"text","value":"track"}]},{"type":"element","tag":"span","props":{"class":"ct-34af82"},"children":[{"type":"text","value":"()"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Next, we want to be able to maintain the statistics themselves. We’ll therefore need methods that correspond to SQL aggregation methods e.g. "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"COUNT"}]},{"type":"text","value":", "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"MAX"}]},{"type":"text","value":", "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"MIN"}]},{"type":"text","value":", "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"SUM"}]},{"type":"text","value":", "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"AVG"}]},{"type":"text","value":":"}]},{"type":"element","tag":"code","props":{"code":"Article::track()\n    ->count()      // Count all records\n    ->sum('likes') // Get the sum of the 'likes' column\n","language":"php"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-35a0ab"},"children":[{"type":"text","value":"Article"}]},{"type":"element","tag":"span","props":{"class":"ct-5af895"},"children":[{"type":"text","value":"::"}]},{"type":"element","tag":"span","props":{"class":"ct-0c2924"},"children":[{"type":"text","value":"track"}]},{"type":"element","tag":"span","props":{"class":"ct-34af82"},"children":[{"type":"text","value":"()"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-34af82"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-5af895"},"children":[{"type":"text","value":"->"}]},{"type":"element","tag":"span","props":{"class":"ct-0c2924"},"children":[{"type":"text","value":"count"}]},{"type":"element","tag":"span","props":{"class":"ct-34af82"},"children":[{"type":"text","value":"()      "}]},{"type":"element","tag":"span","props":{"class":"ct-208bec"},"children":[{"type":"text","value":"// Count all records"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-34af82"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-5af895"},"children":[{"type":"text","value":"->"}]},{"type":"element","tag":"span","props":{"class":"ct-0c2924"},"children":[{"type":"text","value":"sum"}]},{"type":"element","tag":"span","props":{"class":"ct-34af82"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-702cac"},"children":[{"type":"text","value":"'likes'"}]},{"type":"element","tag":"span","props":{"class":"ct-34af82"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"class":"ct-208bec"},"children":[{"type":"text","value":"// Get the sum of the 'likes' column"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Finally, we just need to instruct Laravel to go ahead and create an empty statistic record, as well as install the triggers:"}]},{"type":"element","tag":"code","props":{"code":"Article::track()\n    ->count()\n    ->sum('likes')\n    ->create()\n","language":"php"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-35a0ab"},"children":[{"type":"text","value":"Article"}]},{"type":"element","tag":"span","props":{"class":"ct-5af895"},"children":[{"type":"text","value":"::"}]},{"type":"element","tag":"span","props":{"class":"ct-0c2924"},"children":[{"type":"text","value":"track"}]},{"type":"element","tag":"span","props":{"class":"ct-34af82"},"children":[{"type":"text","value":"()"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-34af82"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-5af895"},"children":[{"type":"text","value":"->"}]},{"type":"element","tag":"span","props":{"class":"ct-0c2924"},"children":[{"type":"text","value":"count"}]},{"type":"element","tag":"span","props":{"class":"ct-34af82"},"children":[{"type":"text","value":"()"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-34af82"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-5af895"},"children":[{"type":"text","value":"->"}]},{"type":"element","tag":"span","props":{"class":"ct-0c2924"},"children":[{"type":"text","value":"sum"}]},{"type":"element","tag":"span","props":{"class":"ct-34af82"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-702cac"},"children":[{"type":"text","value":"'likes'"}]},{"type":"element","tag":"span","props":{"class":"ct-34af82"},"children":[{"type":"text","value":")"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-34af82"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-5af895"},"children":[{"type":"text","value":"->"}]},{"type":"element","tag":"span","props":{"class":"ct-0c2924"},"children":[{"type":"text","value":"create"}]},{"type":"element","tag":"span","props":{"class":"ct-34af82"},"children":[{"type":"text","value":"()"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"And that’s all there is to it. Accurate aggregations that are constantly kept in sync without any ongoing application logic being needed!"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"You can starting using "},{"type":"element","tag":"a","props":{"href":"https://github.com/caneara/statistics","rel":["nofollow"]},"children":[{"type":"text","value":"this package"}]},{"type":"text","value":" right away in your own apps and it also includes further documentation to explain how it works."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When you’re ready to start adding further triggers, e.g. for maintaining statistics on individual records ("},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"article -> likes, views, comments"}]},{"type":"text","value":" etc.) why not dive into the source to see how its done."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"wrapping-up"},"children":[{"type":"text","value":"Wrapping Up"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I hope you enjoyed this article and that you found something interesting in it. If you’d like to see more from me, then you can follow me on Twitter."}]},{"type":"element","tag":"style","children":[{"type":"text","value":".ct-702cac{color:#0A3069}.ct-208bec{color:#6E7781}.ct-34af82{color:#24292F}.ct-0c2924{color:#8250DF}.ct-5af895{color:#CF222E}.ct-35a0ab{color:#0550AE}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"getting-started","depth":3,"text":"Getting started"},{"id":"triggers-to-the-rescue","depth":3,"text":"Triggers to the rescue"},{"id":"adding-trigger-support-to-laravel","depth":3,"text":"Adding trigger support to Laravel"},{"id":"easily-add-and-maintain-statistics","depth":3,"text":"Easily add and maintain statistics"},{"id":"wrapping-up","depth":3,"text":"Wrapping Up"}]}},"_type":"markdown","_id":"content:articles:2.maintain-statistics-about-your-database-tables-using-laravel-and-triggers.md","_source":"content","_file":"articles/2.maintain-statistics-about-your-database-tables-using-laravel-and-triggers.md","_extension":"md"}