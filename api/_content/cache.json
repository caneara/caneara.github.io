{"generatedAt":1670409329302,"generateTime":14,"contents":[{"_path":"/articles/thoughts-on-a-browsers-back-button","_dir":"articles","_draft":false,"_partial":false,"_locale":"en","_empty":false,"title":"Articles - Thoughts on a browser's 'back' button","description":"A few days ago, @adamwathan ran a poll asking whether people felt that the browser's 'back' button should return the previous page exactly as it was when the person viewed it, or whether its content should be refreshed so that it was up to date.","excerpt":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"thoughts-on-a-browsers-back-button"},"children":[{"type":"text","value":"Thoughts on a browser's 'back' button"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"span","props":{"className":["meta"]},"children":[{"type":"text","value":"31st May 2022"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"A few days ago, @adamwathan ran a poll asking whether people felt that the browser's 'back' button should return the previous page exactly as it was when the person viewed it, or whether its content should be refreshed so that it was up to date."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I felt it should be the later, however I was clearly in the minority. This got me thinking as to whether my expectations were wrong. So, I figured I'd explore why I believe the 'back' button should not use a cached version of the page."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"overview"},"children":[{"type":"text","value":"Overview"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"After ruminating on the subject for a bit, I came to the conclusion that this subject consists of four key areas:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"History"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Audience"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Complexity"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Expectations"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Let's explore each of them, and why I feel that, when combined, the 'back' button should be used to refresh the page content."}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I'm not trying to change any minds (or start a flame war here), however since this seems to be the minority opinion, I believe it deserves some discussion. I am also aware that there are certain benefits to cached pages e.g. preserving form content, but I feel they are outweighed by the cons."}]}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"history"},"children":[{"type":"text","value":"History"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Back in the days of the early web, almost everything was static and simple (no JavaScript). It also didn't change with anywhere near the frequency that content does today. As such, browser-based page caching was a very simple thing to implement (and it made a lot of sense)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When you clicked 'back', the browser would just return the exact same HTML and it would all work fine since it wasn't doing anything complex e.g. state-related. As developers, many of us grew up understanding that this is how the browser works when you click 'back' and that philosophy is now engrained in our mindset."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"However, imagine that web 1.0 never existed. Imagine that the web launched with all the fancy bells and whistles we have today. Would you still expect the 'back' button to behave exactly the same?"}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"audience"},"children":[{"type":"text","value":"Audience"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This second point rolls on from the first. As developers, we know the ins and outs of what the browser actually does when we click 'back' (fetching from cache and so on)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"However, if you asked a non-tech-savvy person what the 'back' button does, I'm fairly confident they would tell you that it goes to the previous web address or page. They wouldn't know that it loads a cached page (or why). They would most likely think that the browser loads it all from scratch again."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"While we understand this isn't the case (and might find value in loading a cached page), for everyone else, it is likely to be confusing. This is particularly true if they've done something which would alter the content of the previous page when refreshed (see expectations below)."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"complexity"},"children":[{"type":"text","value":"Complexity"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I think it is fair to say that we don't really build web sites anymore. We build web applications. These apps have become more and more complex as the years go by. We've got SPAs, state management, events & listeners, history / popstate and polling (to name just a few)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"It's hard enough when we've written the code entirely ourselves, but we're often using frameworks and libraries, each of which are trying to manage (and preserve) state. In addition, it is often impractical (or sometimes even not possible) to make code changes to these dependencies."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When you combine these dependencies and complexity, it is inevitable that something will break at some point. If you're lucky, you'll still get a usable page, but sometimes it will break before anything gets rendered and the user will just get a blank page."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If you dispense with the cache, and instead load from scratch, you'll lessen the risk of this happening, though admittedly this has drawbacks (e.g. server load)."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"expectations"},"children":[{"type":"text","value":"Expectations"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This last point is a little bit more lower-level, which is nice in that it gets the point across in a more practical and less theoretical context:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Consider you have an 'index' page for your blog."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"You click on a link on this page to take you to the 'edit' page for a particular blog post."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"You then update its title and set it to published."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"You then press the 'save' button."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"You then hit 'back' to go to the index page."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Using classic behaviour, the browser shows you the blog post's old title and published status. As a developer, we know why this has happened. However, a non-tech-savvy user sees this and may think that the changes haven't been saved. Worse, they then click edit and see the revised changes."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"At best, it's confusing, but at worst, it can cause real stress e.g. if the user is doing something that involves a financial transaction."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"wrapping-up"},"children":[{"type":"text","value":"Wrapping up"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Put all this together and (to me, at least), it becomes clear that expecting classic 'back' button behaviour within modern, interactive, state-heavy web apps is not realistic (even more so if they are regularly receiving new content e.g. a social media platform)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Even if we understand the legacy that explains the classic behaviour, is it really justifable to continue to push that legacy to a modern environment (SPAs etc.) as well as to a modern audience that has a different set of expectations?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Thanks for reading!"}]}]},"date":"31st May 2022","image":{"src":"/images/articles/1.thoughts-on-a-browsers-back-button.jpg"},"head":{"meta":[{"property":"og:title","content":"Thoughts on a browser's 'back' button"},{"property":"og:description","content":"A few days ago, @adamwathan ran a poll asking whether people felt that the browser's 'back' button should return the previous page exactly as it was when the person viewed it, or whether its content should be refreshed so that it was up to date."}]},"body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"thoughts-on-a-browsers-back-button"},"children":[{"type":"text","value":"Thoughts on a browser's 'back' button"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"span","props":{"className":["meta"]},"children":[{"type":"text","value":"31st May 2022"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"A few days ago, @adamwathan ran a poll asking whether people felt that the browser's 'back' button should return the previous page exactly as it was when the person viewed it, or whether its content should be refreshed so that it was up to date."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I felt it should be the later, however I was clearly in the minority. This got me thinking as to whether my expectations were wrong. So, I figured I'd explore why I believe the 'back' button should not use a cached version of the page."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"overview"},"children":[{"type":"text","value":"Overview"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"After ruminating on the subject for a bit, I came to the conclusion that this subject consists of four key areas:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"History"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Audience"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Complexity"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Expectations"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Let's explore each of them, and why I feel that, when combined, the 'back' button should be used to refresh the page content."}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I'm not trying to change any minds (or start a flame war here), however since this seems to be the minority opinion, I believe it deserves some discussion. I am also aware that there are certain benefits to cached pages e.g. preserving form content, but I feel they are outweighed by the cons."}]}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"history"},"children":[{"type":"text","value":"History"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Back in the days of the early web, almost everything was static and simple (no JavaScript). It also didn't change with anywhere near the frequency that content does today. As such, browser-based page caching was a very simple thing to implement (and it made a lot of sense)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When you clicked 'back', the browser would just return the exact same HTML and it would all work fine since it wasn't doing anything complex e.g. state-related. As developers, many of us grew up understanding that this is how the browser works when you click 'back' and that philosophy is now engrained in our mindset."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"However, imagine that web 1.0 never existed. Imagine that the web launched with all the fancy bells and whistles we have today. Would you still expect the 'back' button to behave exactly the same?"}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"audience"},"children":[{"type":"text","value":"Audience"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This second point rolls on from the first. As developers, we know the ins and outs of what the browser actually does when we click 'back' (fetching from cache and so on)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"However, if you asked a non-tech-savvy person what the 'back' button does, I'm fairly confident they would tell you that it goes to the previous web address or page. They wouldn't know that it loads a cached page (or why). They would most likely think that the browser loads it all from scratch again."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"While we understand this isn't the case (and might find value in loading a cached page), for everyone else, it is likely to be confusing. This is particularly true if they've done something which would alter the content of the previous page when refreshed (see expectations below)."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"complexity"},"children":[{"type":"text","value":"Complexity"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I think it is fair to say that we don't really build web sites anymore. We build web applications. These apps have become more and more complex as the years go by. We've got SPAs, state management, events & listeners, history / popstate and polling (to name just a few)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"It's hard enough when we've written the code entirely ourselves, but we're often using frameworks and libraries, each of which are trying to manage (and preserve) state. In addition, it is often impractical (or sometimes even not possible) to make code changes to these dependencies."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When you combine these dependencies and complexity, it is inevitable that something will break at some point. If you're lucky, you'll still get a usable page, but sometimes it will break before anything gets rendered and the user will just get a blank page."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If you dispense with the cache, and instead load from scratch, you'll lessen the risk of this happening, though admittedly this has drawbacks (e.g. server load)."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"expectations"},"children":[{"type":"text","value":"Expectations"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This last point is a little bit more lower-level, which is nice in that it gets the point across in a more practical and less theoretical context:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Consider you have an 'index' page for your blog."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"You click on a link on this page to take you to the 'edit' page for a particular blog post."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"You then update its title and set it to published."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"You then press the 'save' button."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"You then hit 'back' to go to the index page."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Using classic behaviour, the browser shows you the blog post's old title and published status. As a developer, we know why this has happened. However, a non-tech-savvy user sees this and may think that the changes haven't been saved. Worse, they then click edit and see the revised changes."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"At best, it's confusing, but at worst, it can cause real stress e.g. if the user is doing something that involves a financial transaction."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"wrapping-up"},"children":[{"type":"text","value":"Wrapping up"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Put all this together and (to me, at least), it becomes clear that expecting classic 'back' button behaviour within modern, interactive, state-heavy web apps is not realistic (even more so if they are regularly receiving new content e.g. a social media platform)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Even if we understand the legacy that explains the classic behaviour, is it really justifable to continue to push that legacy to a modern environment (SPAs etc.) as well as to a modern audience that has a different set of expectations?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Thanks for reading!"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"overview","depth":3,"text":"Overview"},{"id":"history","depth":3,"text":"History"},{"id":"audience","depth":3,"text":"Audience"},{"id":"complexity","depth":3,"text":"Complexity"},{"id":"expectations","depth":3,"text":"Expectations"},{"id":"wrapping-up","depth":3,"text":"Wrapping up"}]}},"_type":"markdown","_id":"content:articles:1.thoughts-on-a-browsers-back-button.md","_source":"content","_file":"articles/1.thoughts-on-a-browsers-back-button.md","_extension":"md"},{"_path":"/articles/maintain-statistics-about-your-database-tables-using-laravel-and-triggers","_dir":"articles","_draft":false,"_partial":false,"_locale":"en","_empty":false,"title":"Articles - Maintain statistics about your database tables using Laravel and triggers","description":"A couple of weeks ago, I was tackling an issue with a database query that wasn’t performing very well. While indexing helped, having to count millions of records is always going to be slow. I therefore decided to use another approach.","excerpt":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"maintain-statistics-about-your-database-tables-using-laravel-and-triggers"},"children":[{"type":"text","value":"Maintain statistics about your database tables using Laravel and triggers"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"span","props":{"className":["meta"]},"children":[{"type":"text","value":"8th February 2022"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"A couple of weeks ago, I was tackling an issue with a database query that wasn’t performing very well. The problem stemmed from attempting to do a count on a large number of records. While indexing helped, having to count millions of records is always going to be slow. I therefore decided that using a statistics table and maintaining the current count would be a better approach."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"getting-started"},"children":[{"type":"text","value":"Getting started"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"As you might expect within a Laravel application, I first created a "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"statistics"}]},{"type":"text","value":" table that had a table "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"name"}]},{"type":"text","value":" column and a "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"JSON"}]},{"type":"text","value":" values column. Next, I had to write the code to create statistic records and maintain them."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"One approach for this, is to use model events. These are fired automatically by Laravel when a model is created, deleted etc. However, while they are very powerful and definitely have their uses, there are some major drawbacks to trying to maintain statistics by using them:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Model events are only fired on model instances. So, if you run a database query to, say mass-delete some records, then no events will be fired."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Maintaining statistics within your app means that any database activity MUST go through your app. If you delete a record using a tool like TablePlus or Sequel Ace, then your stats won’t get updated."}]}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"triggers-to-the-rescue"},"children":[{"type":"text","value":"Triggers to the rescue"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Database triggers are a lot like model events, except they are physically wired into the database itself, which means that they are fired no matter what app, tool or person is responsible for altering the database state (whether it is one record you’re working with or one thousand)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Of course, since they are part of the database itself, the code statements that they execute must be pure SQL. This can make for a less than ideal developer experience, particularly if you’re not great when it comes to writing SQL, but for what I wanted to do, I knew it wouldn’t be too complicated."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"adding-trigger-support-to-laravel"},"children":[{"type":"text","value":"Adding trigger support to Laravel"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Out of the box, triggers are not supported in Laravel, so I had to first build a package that would allow me to easily add triggers to any table I wanted. This package is "},{"type":"element","tag":"a","props":{"href":"https://github.com/caneara/triggers","rel":["nofollow"]},"children":[{"type":"text","value":"available here"}]},{"type":"text","value":" and includes full documentation."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If you’ve worked with model events before (or used "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"Observer"}]},{"type":"text","value":" classes), then it should feel extremely familiar. The only downside, as mentioned above, is that you need to write raw SQL to make them work. As Laravel developers, we like to abstract such logic behind a friendly API..."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"easily-add-and-maintain-statistics"},"children":[{"type":"text","value":"Easily add and maintain statistics"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now that triggers can be added, and I have my statistics table, all I needed to do was add some helpful methods to create the triggers and aggregate column values. Given that triggers require their database table to already exist, I think it makes sense to start the statistic creation process from the Model class e.g."}]},{"type":"element","tag":"code","props":{"code":"Article::track()\n","language":"php"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"Article::track()\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Next, we want to be able to maintain the statistics themselves. We’ll therefore need methods that correspond to SQL aggregation methods e.g. "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"COUNT"}]},{"type":"text","value":", "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"MAX"}]},{"type":"text","value":", "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"MIN"}]},{"type":"text","value":", "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"SUM"}]},{"type":"text","value":", "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"AVG"}]},{"type":"text","value":":"}]},{"type":"element","tag":"code","props":{"code":"Article::track()\n    ->count()      // Count all records\n    ->sum('likes') // Get the sum of the 'likes' column\n","language":"php"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"Article::track()\n    ->count()      // Count all records\n    ->sum('likes') // Get the sum of the 'likes' column\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Finally, we just need to instruct Laravel to go ahead and create an empty statistic record, as well as install the triggers:"}]},{"type":"element","tag":"code","props":{"code":"Article::track()\n    ->count()\n    ->sum('likes')\n    ->create()\n","language":"php"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"Article::track()\n    ->count()\n    ->sum('likes')\n    ->create()\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"And that’s all there is to it. Accurate aggregations that are constantly kept in sync without any ongoing application logic being needed!"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"You can starting using "},{"type":"element","tag":"a","props":{"href":"https://github.com/caneara/statistics","rel":["nofollow"]},"children":[{"type":"text","value":"this package"}]},{"type":"text","value":" right away in your own apps and it also includes further documentation to explain how it works."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When you’re ready to start adding further triggers, e.g. for maintaining statistics on individual records ("},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"article -> likes, views, comments"}]},{"type":"text","value":" etc.) why not dive into the source to see how its done."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"wrapping-up"},"children":[{"type":"text","value":"Wrapping Up"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I hope you enjoyed this article and that you found something interesting in it. If you’d like to see more from me, then you can follow me on Twitter."}]}]},"date":"8th February 2022","image":{"src":"/images/articles/2.setting-up-an-s3-bucket-and-cloudfront-distribution-for-a-laravel-vapor-storage-disk.jpg"},"head":{"meta":[{"property":"og:title","content":"Maintain statistics about your database tables using Laravel and triggers"},{"property":"og:description","content":"A couple of weeks ago, I was tackling an issue with a database query that wasn’t performing very well. While indexing helped, having to count millions of records is always going to be slow. I therefore decided to use another approach."}]},"body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"maintain-statistics-about-your-database-tables-using-laravel-and-triggers"},"children":[{"type":"text","value":"Maintain statistics about your database tables using Laravel and triggers"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"span","props":{"className":["meta"]},"children":[{"type":"text","value":"8th February 2022"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"A couple of weeks ago, I was tackling an issue with a database query that wasn’t performing very well. The problem stemmed from attempting to do a count on a large number of records. While indexing helped, having to count millions of records is always going to be slow. I therefore decided that using a statistics table and maintaining the current count would be a better approach."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"getting-started"},"children":[{"type":"text","value":"Getting started"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"As you might expect within a Laravel application, I first created a "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"statistics"}]},{"type":"text","value":" table that had a table "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"name"}]},{"type":"text","value":" column and a "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"JSON"}]},{"type":"text","value":" values column. Next, I had to write the code to create statistic records and maintain them."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"One approach for this, is to use model events. These are fired automatically by Laravel when a model is created, deleted etc. However, while they are very powerful and definitely have their uses, there are some major drawbacks to trying to maintain statistics by using them:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Model events are only fired on model instances. So, if you run a database query to, say mass-delete some records, then no events will be fired."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Maintaining statistics within your app means that any database activity MUST go through your app. If you delete a record using a tool like TablePlus or Sequel Ace, then your stats won’t get updated."}]}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"triggers-to-the-rescue"},"children":[{"type":"text","value":"Triggers to the rescue"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Database triggers are a lot like model events, except they are physically wired into the database itself, which means that they are fired no matter what app, tool or person is responsible for altering the database state (whether it is one record you’re working with or one thousand)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Of course, since they are part of the database itself, the code statements that they execute must be pure SQL. This can make for a less than ideal developer experience, particularly if you’re not great when it comes to writing SQL, but for what I wanted to do, I knew it wouldn’t be too complicated."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"adding-trigger-support-to-laravel"},"children":[{"type":"text","value":"Adding trigger support to Laravel"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Out of the box, triggers are not supported in Laravel, so I had to first build a package that would allow me to easily add triggers to any table I wanted. This package is "},{"type":"element","tag":"a","props":{"href":"https://github.com/caneara/triggers","rel":["nofollow"]},"children":[{"type":"text","value":"available here"}]},{"type":"text","value":" and includes full documentation."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If you’ve worked with model events before (or used "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"Observer"}]},{"type":"text","value":" classes), then it should feel extremely familiar. The only downside, as mentioned above, is that you need to write raw SQL to make them work. As Laravel developers, we like to abstract such logic behind a friendly API..."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"easily-add-and-maintain-statistics"},"children":[{"type":"text","value":"Easily add and maintain statistics"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now that triggers can be added, and I have my statistics table, all I needed to do was add some helpful methods to create the triggers and aggregate column values. Given that triggers require their database table to already exist, I think it makes sense to start the statistic creation process from the Model class e.g."}]},{"type":"element","tag":"code","props":{"code":"Article::track()\n","language":"php"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b31c"},"children":[{"type":"text","value":"Article"}]},{"type":"element","tag":"span","props":{"class":"ct-0379fa"},"children":[{"type":"text","value":"::"}]},{"type":"element","tag":"span","props":{"class":"ct-a8c7dd"},"children":[{"type":"text","value":"track"}]},{"type":"element","tag":"span","props":{"class":"ct-194b7f"},"children":[{"type":"text","value":"()"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Next, we want to be able to maintain the statistics themselves. We’ll therefore need methods that correspond to SQL aggregation methods e.g. "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"COUNT"}]},{"type":"text","value":", "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"MAX"}]},{"type":"text","value":", "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"MIN"}]},{"type":"text","value":", "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"SUM"}]},{"type":"text","value":", "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"AVG"}]},{"type":"text","value":":"}]},{"type":"element","tag":"code","props":{"code":"Article::track()\n    ->count()      // Count all records\n    ->sum('likes') // Get the sum of the 'likes' column\n","language":"php"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b31c"},"children":[{"type":"text","value":"Article"}]},{"type":"element","tag":"span","props":{"class":"ct-0379fa"},"children":[{"type":"text","value":"::"}]},{"type":"element","tag":"span","props":{"class":"ct-a8c7dd"},"children":[{"type":"text","value":"track"}]},{"type":"element","tag":"span","props":{"class":"ct-194b7f"},"children":[{"type":"text","value":"()"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-194b7f"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-0379fa"},"children":[{"type":"text","value":"->"}]},{"type":"element","tag":"span","props":{"class":"ct-a8c7dd"},"children":[{"type":"text","value":"count"}]},{"type":"element","tag":"span","props":{"class":"ct-194b7f"},"children":[{"type":"text","value":"()      "}]},{"type":"element","tag":"span","props":{"class":"ct-cae21e"},"children":[{"type":"text","value":"// Count all records"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-194b7f"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-0379fa"},"children":[{"type":"text","value":"->"}]},{"type":"element","tag":"span","props":{"class":"ct-a8c7dd"},"children":[{"type":"text","value":"sum"}]},{"type":"element","tag":"span","props":{"class":"ct-194b7f"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-2e683f"},"children":[{"type":"text","value":"'likes'"}]},{"type":"element","tag":"span","props":{"class":"ct-194b7f"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"class":"ct-cae21e"},"children":[{"type":"text","value":"// Get the sum of the 'likes' column"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Finally, we just need to instruct Laravel to go ahead and create an empty statistic record, as well as install the triggers:"}]},{"type":"element","tag":"code","props":{"code":"Article::track()\n    ->count()\n    ->sum('likes')\n    ->create()\n","language":"php"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-59b31c"},"children":[{"type":"text","value":"Article"}]},{"type":"element","tag":"span","props":{"class":"ct-0379fa"},"children":[{"type":"text","value":"::"}]},{"type":"element","tag":"span","props":{"class":"ct-a8c7dd"},"children":[{"type":"text","value":"track"}]},{"type":"element","tag":"span","props":{"class":"ct-194b7f"},"children":[{"type":"text","value":"()"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-194b7f"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-0379fa"},"children":[{"type":"text","value":"->"}]},{"type":"element","tag":"span","props":{"class":"ct-a8c7dd"},"children":[{"type":"text","value":"count"}]},{"type":"element","tag":"span","props":{"class":"ct-194b7f"},"children":[{"type":"text","value":"()"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-194b7f"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-0379fa"},"children":[{"type":"text","value":"->"}]},{"type":"element","tag":"span","props":{"class":"ct-a8c7dd"},"children":[{"type":"text","value":"sum"}]},{"type":"element","tag":"span","props":{"class":"ct-194b7f"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-2e683f"},"children":[{"type":"text","value":"'likes'"}]},{"type":"element","tag":"span","props":{"class":"ct-194b7f"},"children":[{"type":"text","value":")"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-194b7f"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-0379fa"},"children":[{"type":"text","value":"->"}]},{"type":"element","tag":"span","props":{"class":"ct-a8c7dd"},"children":[{"type":"text","value":"create"}]},{"type":"element","tag":"span","props":{"class":"ct-194b7f"},"children":[{"type":"text","value":"()"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"And that’s all there is to it. Accurate aggregations that are constantly kept in sync without any ongoing application logic being needed!"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"You can starting using "},{"type":"element","tag":"a","props":{"href":"https://github.com/caneara/statistics","rel":["nofollow"]},"children":[{"type":"text","value":"this package"}]},{"type":"text","value":" right away in your own apps and it also includes further documentation to explain how it works."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When you’re ready to start adding further triggers, e.g. for maintaining statistics on individual records ("},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"article -> likes, views, comments"}]},{"type":"text","value":" etc.) why not dive into the source to see how its done."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"wrapping-up"},"children":[{"type":"text","value":"Wrapping Up"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I hope you enjoyed this article and that you found something interesting in it. If you’d like to see more from me, then you can follow me on Twitter."}]},{"type":"element","tag":"style","children":[{"type":"text","value":".ct-2e683f{color:#0A3069}.ct-cae21e{color:#6E7781}.ct-194b7f{color:#24292F}.ct-a8c7dd{color:#8250DF}.ct-0379fa{color:#CF222E}.ct-59b31c{color:#0550AE}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"getting-started","depth":3,"text":"Getting started"},{"id":"triggers-to-the-rescue","depth":3,"text":"Triggers to the rescue"},{"id":"adding-trigger-support-to-laravel","depth":3,"text":"Adding trigger support to Laravel"},{"id":"easily-add-and-maintain-statistics","depth":3,"text":"Easily add and maintain statistics"},{"id":"wrapping-up","depth":3,"text":"Wrapping Up"}]}},"_type":"markdown","_id":"content:articles:2.maintain-statistics-about-your-database-tables-using-laravel-and-triggers.md","_source":"content","_file":"articles/2.maintain-statistics-about-your-database-tables-using-laravel-and-triggers.md","_extension":"md"},{"_path":"/articles/using-twitter-snowflake-ids-for-your-database-primary-keys-in-laravel","_dir":"articles","_draft":false,"_partial":false,"_locale":"en","_empty":false,"title":"Articles - Using Twitter Snowflake IDs for your database primary keys in Laravel","description":"Yesterday, I published an article where I compared UUIDs, ULIDs and Twitter Snowflakes for use as your database primary key. I ended up selecting Snowflakes because it has some significant benefits.","excerpt":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"how-to-use-twitter-snowflake-ids-for-your-database-primary-keys-in-laravel"},"children":[{"type":"text","value":"How to use Twitter Snowflake IDs for your database primary keys in Laravel"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"span","props":{"className":["meta"]},"children":[{"type":"text","value":"11th January 2022"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Yesterday, I published an article where I compared UUIDs, ULIDs and Twitter Snowflakes for use as your database primary key. I ended up selecting Twitter Snowflakes because it has some significant benefits:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"It consists entirely of integers."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"It uses less space (16 characters, so it fits in a "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"BIGINT"}]},{"type":"text","value":")."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Indexing of integers is much faster than indexing a string."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Keys begin with a timestamp, so are sortable."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Keys end with a random number, so guessing table size is not possible."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Queries that JOIN on the keys will be faster."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Databases handle integers more efficiently than strings."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Generation of new keys is faster (less than 1 ms)."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In this article, I want to document how you can get set up with Snowflakes in your Laravel application. Fortunately, it’s pretty easy."}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Update"}]},{"type":"text","value":": I've released a package to do what you'll find below."}]}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"install-snowflake"},"children":[{"type":"text","value":"Install Snowflake"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Snowflake was designed by Twitter, and the original implementation was written in Scala. Fortunately, a PHP implementation also exists courtesy of Chinese developer, Godruoyi. We’ll begin by pulling it in with Composer:"}]},{"type":"element","tag":"code","props":{"code":"composer require godruoyi/php-snowflake\n","language":"shell"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"composer require godruoyi/php-snowflake\n"}]}]}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"how-snowflake-works"},"children":[{"type":"text","value":"How Snowflake works"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Owing to how Snowflake was designed, or rather what it was designed to do, you need to set up a few things when first pulling it in. Snowflake is designed to work in a clustered environment where multiple data centres and workers exist and can be used to generate keys. The idea being that you can distribute key generation to reduce load and further reduce the risk of collision."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The PHP implementation allows for this and includes support for up to 31 data centres, and 31 worker nodes within each centre. Since many developers that use the package are unlikely to need this level of distribution, the default approach is to leave these values blank, in which case the package will just select a random number between 1 and 31 for each value."}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Important: This random selection happens each time Laravel is booted. In most cases, it won’t cause any issues. However, it is a good practice to be explicit about which data centre and worker node number should be used. Being explicit allows us to set up a distributed architecture later if we need to do so."}]}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"configuring-snowflake"},"children":[{"type":"text","value":"Configuring Snowflake"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Let’s begin by creating a new configuration file that Snowflake will read from in order to get the number it should use for the data centre and worker node. You can call it whatever you want, but I’ll opt for snowflake.php"}]},{"type":"element","tag":"code","props":{"code":"return [\n    'data_center' => env('SNOWFLAKE_DATA_CENTER', 1),\n    'worker_node' => env('SNOWFLAKE_WORKER', 1),\n];\n","language":"php"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"return [\n    'data_center' => env('SNOWFLAKE_DATA_CENTER', 1),\n    'worker_node' => env('SNOWFLAKE_WORKER', 1),\n];\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This config file attempts to use values supplied in our environment file. If they don’t exist, it uses a default of 1 for the data centre and 1 for the worker node."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Next, we need to initialize Snowflake whenever Laravel boots up. We’ll then store the Snowflake instance in the service container as a "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"singleton"}]},{"type":"text","value":". Doing this ensures that Laravel doesn’t have to create more than one version of the Snowflake object every time we want to create a new key."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"All of this happens within a service provider. I’ll use the "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"AppServiceProvider"}]},{"type":"text","value":" for this article, but feel free to create a new one and register it if you prefer."}]},{"type":"element","tag":"code","props":{"code":"namespace App\\Providers;\n\nuse Godruoyi\\Snowflake\\Snowflake;\nuse Illuminate\\Support\\ServiceProvider;\nuse Godruoyi\\Snowflake\\RandomSequenceResolver;\n\nclass AppServiceProvider extends ServiceProvider\n{\n    public function register() : void\n    {\n        $this->app->singleton('snowflake', function() {\n            return (new Snowflake(\n                config('snowflake.data_center'),\n                config('snowflake.worker_node'))\n            )\n            ->setStartTimeStamp(strtotime('2022-01-01') * 1000)\n            ->setSequenceResolver(new RandomSequenceResolver());\n        });\n    }\n}\n","language":"php"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"namespace App\\Providers;\n\nuse Godruoyi\\Snowflake\\Snowflake;\nuse Illuminate\\Support\\ServiceProvider;\nuse Godruoyi\\Snowflake\\RandomSequenceResolver;\n\nclass AppServiceProvider extends ServiceProvider\n{\n    public function register() : void\n    {\n        $this->app->singleton('snowflake', function() {\n            return (new Snowflake(\n                config('snowflake.data_center'),\n                config('snowflake.worker_node'))\n            )\n            ->setStartTimeStamp(strtotime('2022-01-01') * 1000)\n            ->setSequenceResolver(new RandomSequenceResolver());\n        });\n    }\n}\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Notice that we are calling the "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"setStartTimeStamp"}]},{"type":"text","value":" method. This is important as there are limits to how many Snowflake keys can be generated based on the provided timestamp. When setting up new projects, make sure that you set the date to the current date (and then don’t change it)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The package includes several options for determining how the key sequence is created. You can use any that you wish (including a bespoke Laravel version that exists), however the benefit of using "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"RandomSequenceResolver"}]},{"type":"text","value":" is that it has no dependencies e.g. Redis."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"updating-your-migrations"},"children":[{"type":"text","value":"Updating your migrations"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Since your migrations most likely use integers for your primary keys, there isn’t much to do here. We simply need to instruct Laravel to use unsigned big integers and not to use auto-incrementation."}]},{"type":"element","tag":"code","props":{"code":"// Before\n$table->id();\n\n// After\n$table->unsignedBigInteger('id')->primary();\n","language":"php"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"// Before\n$table->id();\n\n// After\n$table->unsignedBigInteger('id')->primary();\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here’s an example:"}]},{"type":"element","tag":"code","props":{"code":"class CreateUsersTable extends Migration\n{\n    public function up()\n    {\n        Schema::create('users', function(Blueprint $table) {\n            $table->unsignedBigInteger('id')->primary();\n            $table->string('name', 100);\n            $table->timestamps();\n        });\n    }\n}\n","language":"php"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"class CreateUsersTable extends Migration\n{\n    public function up()\n    {\n        Schema::create('users', function(Blueprint $table) {\n            $table->unsignedBigInteger('id')->primary();\n            $table->string('name', 100);\n            $table->timestamps();\n        });\n    }\n}\n"}]}]}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"using-snowflake"},"children":[{"type":"text","value":"Using Snowflake"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We can easily generate a Snowflake ID by resolving the singleton out of the service container and then calling its ID method:"}]},{"type":"element","tag":"code","props":{"code":"resolve('snowflake')->id();\n","language":"php"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"resolve('snowflake')->id();\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"However, we don’t want to generate keys manually. Instead, we want Laravel to automatically set them when we’re creating new models. We’ll also need to tell Laravel to not use auto-incrementation for the primary key."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The easiest way to solve both of these problems, is to create a simple "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"trait"}]},{"type":"text","value":" that we can then use within any relevant model:"}]},{"type":"element","tag":"code","props":{"code":"namespace App\\Traits;\n\ntrait Snowflake\n{\n    protected static function boot()\n    {\n        parent::boot();\n\n        static::creating(function($model) {\n            if (! $model->getKey()) {\n               $key = resolve('snowflake')->id();\n               $model->{$model->getKeyName()} = $key;\n            }\n        });\n    }\n\n    public function getIncrementing()\n    {\n        return false;\n    }\n}\n","language":"php"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"namespace App\\Traits;\n\ntrait Snowflake\n{\n    protected static function boot()\n    {\n        parent::boot();\n\n        static::creating(function($model) {\n            if (! $model->getKey()) {\n               $key = resolve('snowflake')->id();\n               $model->{$model->getKeyName()} = $key;\n            }\n        });\n    }\n\n    public function getIncrementing()\n    {\n        return false;\n    }\n}\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"All we need to do now, is use the trait within our models:"}]},{"type":"element","tag":"code","props":{"code":"namespace App\\Models;\n\nclass User extends Model\n{\n    use Snowflake;\n}\n","language":"php"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"namespace App\\Models;\n\nclass User extends Model\n{\n    use Snowflake;\n}\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"And that’s all there is to it!"}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"wrapping-up"},"children":[{"type":"text","value":"Wrapping Up"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I hope you enjoyed this article and that you found something interesting in it. If you’d like to see more from me, then you can follow me on Twitter."}]}]},"date":"11th January 2022","image":{"src":"/images/articles/3.using-twitter-snowflake-ids-for-your-database-primary-keys-in-laravel.jpg"},"head":{"meta":[{"property":"og:title","content":"Using Twitter Snowflake IDs for your database primary keys in Laravel"},{"property":"og:description","content":"Yesterday, I published an article where I compared UUIDs, ULIDs and Twitter Snowflakes for use as your database primary key. I ended up selecting Snowflakes because it has some significant benefits."}]},"body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"how-to-use-twitter-snowflake-ids-for-your-database-primary-keys-in-laravel"},"children":[{"type":"text","value":"How to use Twitter Snowflake IDs for your database primary keys in Laravel"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"span","props":{"className":["meta"]},"children":[{"type":"text","value":"11th January 2022"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Yesterday, I published an article where I compared UUIDs, ULIDs and Twitter Snowflakes for use as your database primary key. I ended up selecting Twitter Snowflakes because it has some significant benefits:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"It consists entirely of integers."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"It uses less space (16 characters, so it fits in a "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"BIGINT"}]},{"type":"text","value":")."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Indexing of integers is much faster than indexing a string."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Keys begin with a timestamp, so are sortable."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Keys end with a random number, so guessing table size is not possible."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Queries that JOIN on the keys will be faster."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Databases handle integers more efficiently than strings."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Generation of new keys is faster (less than 1 ms)."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In this article, I want to document how you can get set up with Snowflakes in your Laravel application. Fortunately, it’s pretty easy."}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Update"}]},{"type":"text","value":": I've released a package to do what you'll find below."}]}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"install-snowflake"},"children":[{"type":"text","value":"Install Snowflake"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Snowflake was designed by Twitter, and the original implementation was written in Scala. Fortunately, a PHP implementation also exists courtesy of Chinese developer, Godruoyi. We’ll begin by pulling it in with Composer:"}]},{"type":"element","tag":"code","props":{"code":"composer require godruoyi/php-snowflake\n","language":"shell"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"composer require godruoyi/php-snowflake"}]}]}]}]}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"how-snowflake-works"},"children":[{"type":"text","value":"How Snowflake works"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Owing to how Snowflake was designed, or rather what it was designed to do, you need to set up a few things when first pulling it in. Snowflake is designed to work in a clustered environment where multiple data centres and workers exist and can be used to generate keys. The idea being that you can distribute key generation to reduce load and further reduce the risk of collision."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The PHP implementation allows for this and includes support for up to 31 data centres, and 31 worker nodes within each centre. Since many developers that use the package are unlikely to need this level of distribution, the default approach is to leave these values blank, in which case the package will just select a random number between 1 and 31 for each value."}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Important: This random selection happens each time Laravel is booted. In most cases, it won’t cause any issues. However, it is a good practice to be explicit about which data centre and worker node number should be used. Being explicit allows us to set up a distributed architecture later if we need to do so."}]}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"configuring-snowflake"},"children":[{"type":"text","value":"Configuring Snowflake"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Let’s begin by creating a new configuration file that Snowflake will read from in order to get the number it should use for the data centre and worker node. You can call it whatever you want, but I’ll opt for snowflake.php"}]},{"type":"element","tag":"code","props":{"code":"return [\n    'data_center' => env('SNOWFLAKE_DATA_CENTER', 1),\n    'worker_node' => env('SNOWFLAKE_WORKER', 1),\n];\n","language":"php"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"return"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" ["}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-ce5293"},"children":[{"type":"text","value":"'data_center'"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"=>"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-11c537"},"children":[{"type":"text","value":"env"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-ce5293"},"children":[{"type":"text","value":"'SNOWFLAKE_DATA_CENTER'"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"class":"ct-6c3a51"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"),"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-ce5293"},"children":[{"type":"text","value":"'worker_node'"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"=>"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-11c537"},"children":[{"type":"text","value":"env"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-ce5293"},"children":[{"type":"text","value":"'SNOWFLAKE_WORKER'"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"class":"ct-6c3a51"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"),"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"];"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This config file attempts to use values supplied in our environment file. If they don’t exist, it uses a default of 1 for the data centre and 1 for the worker node."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Next, we need to initialize Snowflake whenever Laravel boots up. We’ll then store the Snowflake instance in the service container as a "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"singleton"}]},{"type":"text","value":". Doing this ensures that Laravel doesn’t have to create more than one version of the Snowflake object every time we want to create a new key."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"All of this happens within a service provider. I’ll use the "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"AppServiceProvider"}]},{"type":"text","value":" for this article, but feel free to create a new one and register it if you prefer."}]},{"type":"element","tag":"code","props":{"code":"namespace App\\Providers;\n\nuse Godruoyi\\Snowflake\\Snowflake;\nuse Illuminate\\Support\\ServiceProvider;\nuse Godruoyi\\Snowflake\\RandomSequenceResolver;\n\nclass AppServiceProvider extends ServiceProvider\n{\n    public function register() : void\n    {\n        $this->app->singleton('snowflake', function() {\n            return (new Snowflake(\n                config('snowflake.data_center'),\n                config('snowflake.worker_node'))\n            )\n            ->setStartTimeStamp(strtotime('2022-01-01') * 1000)\n            ->setSequenceResolver(new RandomSequenceResolver());\n        });\n    }\n}\n","language":"php"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"namespace"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-43dfe6"},"children":[{"type":"text","value":"App\\Providers"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":";"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"use"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-6c3a51"},"children":[{"type":"text","value":"Godruoyi\\Snowflake\\Snowflake"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":";"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"use"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-6c3a51"},"children":[{"type":"text","value":"Illuminate\\Support\\ServiceProvider"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":";"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"use"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-6c3a51"},"children":[{"type":"text","value":"Godruoyi\\Snowflake\\RandomSequenceResolver"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":";"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"class"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-43dfe6"},"children":[{"type":"text","value":"AppServiceProvider"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"extends"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-6c3a51"},"children":[{"type":"text","value":"ServiceProvider"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"{"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"public"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-11c537"},"children":[{"type":"text","value":"register"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"() "}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":":"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"void"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"    {"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-6c3a51"},"children":[{"type":"text","value":"$this"}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"->"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"app"}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"->"}]},{"type":"element","tag":"span","props":{"class":"ct-11c537"},"children":[{"type":"text","value":"singleton"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-ce5293"},"children":[{"type":"text","value":"'snowflake'"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"() {"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"            "}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"return"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"new"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-6c3a51"},"children":[{"type":"text","value":"Snowflake"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"("}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"                "}]},{"type":"element","tag":"span","props":{"class":"ct-11c537"},"children":[{"type":"text","value":"config"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-ce5293"},"children":[{"type":"text","value":"'snowflake.data_center'"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"),"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"                "}]},{"type":"element","tag":"span","props":{"class":"ct-11c537"},"children":[{"type":"text","value":"config"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-ce5293"},"children":[{"type":"text","value":"'snowflake.worker_node'"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"))"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"            )"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"            "}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"->"}]},{"type":"element","tag":"span","props":{"class":"ct-11c537"},"children":[{"type":"text","value":"setStartTimeStamp"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-6c3a51"},"children":[{"type":"text","value":"strtotime"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-ce5293"},"children":[{"type":"text","value":"'2022-01-01'"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"*"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-6c3a51"},"children":[{"type":"text","value":"1000"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":")"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"            "}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"->"}]},{"type":"element","tag":"span","props":{"class":"ct-11c537"},"children":[{"type":"text","value":"setSequenceResolver"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"new"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-6c3a51"},"children":[{"type":"text","value":"RandomSequenceResolver"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"());"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"        });"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"    }"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"}"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Notice that we are calling the "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"setStartTimeStamp"}]},{"type":"text","value":" method. This is important as there are limits to how many Snowflake keys can be generated based on the provided timestamp. When setting up new projects, make sure that you set the date to the current date (and then don’t change it)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The package includes several options for determining how the key sequence is created. You can use any that you wish (including a bespoke Laravel version that exists), however the benefit of using "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"RandomSequenceResolver"}]},{"type":"text","value":" is that it has no dependencies e.g. Redis."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"updating-your-migrations"},"children":[{"type":"text","value":"Updating your migrations"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Since your migrations most likely use integers for your primary keys, there isn’t much to do here. We simply need to instruct Laravel to use unsigned big integers and not to use auto-incrementation."}]},{"type":"element","tag":"code","props":{"code":"// Before\n$table->id();\n\n// After\n$table->unsignedBigInteger('id')->primary();\n","language":"php"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-269d86"},"children":[{"type":"text","value":"// Before"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"$table"}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"->"}]},{"type":"element","tag":"span","props":{"class":"ct-11c537"},"children":[{"type":"text","value":"id"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"();"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-269d86"},"children":[{"type":"text","value":"// After"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"$table"}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"->"}]},{"type":"element","tag":"span","props":{"class":"ct-11c537"},"children":[{"type":"text","value":"unsignedBigInteger"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-ce5293"},"children":[{"type":"text","value":"'id'"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":")"}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"->"}]},{"type":"element","tag":"span","props":{"class":"ct-11c537"},"children":[{"type":"text","value":"primary"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"();"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here’s an example:"}]},{"type":"element","tag":"code","props":{"code":"class CreateUsersTable extends Migration\n{\n    public function up()\n    {\n        Schema::create('users', function(Blueprint $table) {\n            $table->unsignedBigInteger('id')->primary();\n            $table->string('name', 100);\n            $table->timestamps();\n        });\n    }\n}\n","language":"php"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"class"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-43dfe6"},"children":[{"type":"text","value":"CreateUsersTable"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"extends"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-6c3a51"},"children":[{"type":"text","value":"Migration"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"{"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"public"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-11c537"},"children":[{"type":"text","value":"up"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"()"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"    {"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-6c3a51"},"children":[{"type":"text","value":"Schema"}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"::"}]},{"type":"element","tag":"span","props":{"class":"ct-11c537"},"children":[{"type":"text","value":"create"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-ce5293"},"children":[{"type":"text","value":"'users'"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-6c3a51"},"children":[{"type":"text","value":"Blueprint"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" $table) {"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"            $table"}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"->"}]},{"type":"element","tag":"span","props":{"class":"ct-11c537"},"children":[{"type":"text","value":"unsignedBigInteger"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-ce5293"},"children":[{"type":"text","value":"'id'"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":")"}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"->"}]},{"type":"element","tag":"span","props":{"class":"ct-11c537"},"children":[{"type":"text","value":"primary"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"();"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"            $table"}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"->"}]},{"type":"element","tag":"span","props":{"class":"ct-11c537"},"children":[{"type":"text","value":"string"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-ce5293"},"children":[{"type":"text","value":"'name'"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"class":"ct-6c3a51"},"children":[{"type":"text","value":"100"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":");"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"            $table"}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"->"}]},{"type":"element","tag":"span","props":{"class":"ct-11c537"},"children":[{"type":"text","value":"timestamps"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"();"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"        });"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"    }"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"}"}]}]}]}]}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"using-snowflake"},"children":[{"type":"text","value":"Using Snowflake"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We can easily generate a Snowflake ID by resolving the singleton out of the service container and then calling its ID method:"}]},{"type":"element","tag":"code","props":{"code":"resolve('snowflake')->id();\n","language":"php"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-11c537"},"children":[{"type":"text","value":"resolve"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-ce5293"},"children":[{"type":"text","value":"'snowflake'"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":")"}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"->"}]},{"type":"element","tag":"span","props":{"class":"ct-11c537"},"children":[{"type":"text","value":"id"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"();"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"However, we don’t want to generate keys manually. Instead, we want Laravel to automatically set them when we’re creating new models. We’ll also need to tell Laravel to not use auto-incrementation for the primary key."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The easiest way to solve both of these problems, is to create a simple "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"trait"}]},{"type":"text","value":" that we can then use within any relevant model:"}]},{"type":"element","tag":"code","props":{"code":"namespace App\\Traits;\n\ntrait Snowflake\n{\n    protected static function boot()\n    {\n        parent::boot();\n\n        static::creating(function($model) {\n            if (! $model->getKey()) {\n               $key = resolve('snowflake')->id();\n               $model->{$model->getKeyName()} = $key;\n            }\n        });\n    }\n\n    public function getIncrementing()\n    {\n        return false;\n    }\n}\n","language":"php"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"namespace"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-43dfe6"},"children":[{"type":"text","value":"App\\Traits"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":";"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"trait"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-43dfe6"},"children":[{"type":"text","value":"Snowflake"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"{"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"protected"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"static"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-11c537"},"children":[{"type":"text","value":"boot"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"()"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"    {"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"parent::"}]},{"type":"element","tag":"span","props":{"class":"ct-11c537"},"children":[{"type":"text","value":"boot"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"();"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"static::"}]},{"type":"element","tag":"span","props":{"class":"ct-11c537"},"children":[{"type":"text","value":"creating"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"($model) {"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"            "}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"if"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"!"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" $model"}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"->"}]},{"type":"element","tag":"span","props":{"class":"ct-11c537"},"children":[{"type":"text","value":"getKey"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"()) {"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"               $key "}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-11c537"},"children":[{"type":"text","value":"resolve"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-ce5293"},"children":[{"type":"text","value":"'snowflake'"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":")"}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"->"}]},{"type":"element","tag":"span","props":{"class":"ct-11c537"},"children":[{"type":"text","value":"id"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"();"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"               $model"}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"->"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"{$model"}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"->"}]},{"type":"element","tag":"span","props":{"class":"ct-11c537"},"children":[{"type":"text","value":"getKeyName"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"()} "}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" $key;"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"            }"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"        });"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"    }"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"public"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-11c537"},"children":[{"type":"text","value":"getIncrementing"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"()"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"    {"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"return"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-6c3a51"},"children":[{"type":"text","value":"false"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":";"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"    }"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"}"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"All we need to do now, is use the trait within our models:"}]},{"type":"element","tag":"code","props":{"code":"namespace App\\Models;\n\nclass User extends Model\n{\n    use Snowflake;\n}\n","language":"php"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"namespace"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-43dfe6"},"children":[{"type":"text","value":"App\\Models"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":";"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"class"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-43dfe6"},"children":[{"type":"text","value":"User"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"extends"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-6c3a51"},"children":[{"type":"text","value":"Model"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"{"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-0bf2a2"},"children":[{"type":"text","value":"use"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-6c3a51"},"children":[{"type":"text","value":"Snowflake"}]},{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":";"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-5b80d7"},"children":[{"type":"text","value":"}"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"And that’s all there is to it!"}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"wrapping-up"},"children":[{"type":"text","value":"Wrapping Up"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I hope you enjoyed this article and that you found something interesting in it. If you’d like to see more from me, then you can follow me on Twitter."}]},{"type":"element","tag":"style","children":[{"type":"text","value":".ct-269d86{color:#6E7781}.ct-43dfe6{color:#953800}.ct-6c3a51{color:#0550AE}.ct-11c537{color:#8250DF}.ct-ce5293{color:#0A3069}.ct-0bf2a2{color:#CF222E}.ct-5b80d7{color:#24292F}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"install-snowflake","depth":3,"text":"Install Snowflake"},{"id":"how-snowflake-works","depth":3,"text":"How Snowflake works"},{"id":"configuring-snowflake","depth":3,"text":"Configuring Snowflake"},{"id":"updating-your-migrations","depth":3,"text":"Updating your migrations"},{"id":"using-snowflake","depth":3,"text":"Using Snowflake"},{"id":"wrapping-up","depth":3,"text":"Wrapping Up"}]}},"_type":"markdown","_id":"content:articles:3.using-twitter-snowflake-ids-for-your-database-primary-keys-in-laravel.md","_source":"content","_file":"articles/3.using-twitter-snowflake-ids-for-your-database-primary-keys-in-laravel.md","_extension":"md"},{"_path":"/articles/choosing-the-right-data-type-means-of-generating-unique-primary-keys","_dir":"articles","_draft":false,"_partial":false,"_locale":"en","_empty":false,"title":"Articles - Choosing the right data type & means of generating unique primary keys","description":"I've been taking some time to investigate the options for how to safely generate unique primary keys for database records. Most of the time, as a developer, you probably won't need to think about this topic, but for those that do, this article is for you.","excerpt":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"choosing-the-right-data-type--means-of-generating-unique-primary-keys"},"children":[{"type":"text","value":"Choosing the right data type & means of generating unique primary keys"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"span","props":{"className":["meta"]},"children":[{"type":"text","value":"10th January 2022"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"While building Lumeno, I've been taking some time to investigate the options for how to safely generate unique primary keys for database records. Most of the time, as a developer, you probably won't need to think about this topic, but for those that do, this article is for you."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"the-voice-of-reason"},"children":[{"type":"text","value":"The voice of reason"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Before we dig into the meat of this topic, it is worth pointing out that I’ve seen quite a few developers assume that they need to use a more complex system in order to generate unique identifiers for their primary keys."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If you’re building a system that is enterprise in nature, or you’re familiar with and need to use features like clusters, regions, replicas, and so on, then this is probably true. However, most of the time, developers are building modest applications powered by databases running on a single, modest server."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If this is you, then the default method of generating unique primary keys (auto-incrementing integers), should serve you just fine. Indeed, there are significant benefits to sticking with them…"}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"auto-incrementing-integers"},"children":[{"type":"text","value":"Auto-incrementing integers"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If you’re at least somewhat familiar with databases, then you’ll know that this is the standard way of generating unique keys. Behind the scenes, the system maintains an internal counter. When you insert a record, it increments the counter and sets the new record’s primary key to that value."}]},{"type":"element","tag":"h5","props":{"id":"is-this-a-good-approach"},"children":[{"type":"text","value":"Is this a good approach?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In short, yes! While there is a slight overhead in maintaining the counter, in practice it’s negligible. On the plus side, your records will always be unique, easily-indexed and super fast (in fact, its always the fastest option)."}]},{"type":"element","tag":"h5","props":{"id":"when-should-i-opt-for-the-something-different"},"children":[{"type":"text","value":"When should I opt for the something different?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I’ve already mentioned a few scenarios when you might want to consider something different, but even in those cases, you should ask yourself if you can still stick with incrementing integers. Sometimes, simply adjusting your schema to use a larger data type e.g. "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"BIG INT"}]},{"type":"text","value":", is enough."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Even if it’s not such a minimal adjustment, in a lot of cases, if you design your application and database correctly, then you can still use them."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"However, if you find you are making too many compromises, your app is becoming unwieldy, or your setup makes it too complex to use a database counter, then it may be time to reach for something else…"}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"alternatives-its-a-jungle-out-there"},"children":[{"type":"text","value":"Alternatives... it’s a jungle out there"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Okay, so you’ve decided that auto-incrementing integers are not for you. What do you use instead? Well, if you consult your database manual, you probably won’t get much help. Databases provide a default method. If you don’t want to use it, then you’re largely on your own. So, you go to the internet…"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Congratulations! You’ve discovered endless different ways of generating a unique string of characters to use as a primary key and you come away with no clear understanding of which one to use. Fortunately, when it comes to a database at least, choosing one really depends on just four things:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Uniqueness"}]},{"type":"text","value":". Every method of generating a key has a possibility of causing a collision (two generated keys being the same). Therefore, you want to choose a method with as low a risk of collision as possible."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Lexicography"}]},{"type":"text","value":". A complicated-sounding word that basically refers to some means of organization. In the database, we’re talking about being able to order our records using the key."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Efficiency"}]},{"type":"text","value":". Depending on the method you choose, your database might already include a function to generate a key using the algorithm. However, even if it does, it may be better to generate it within your app so the DB has less to do. Note that there are tradeoffs with this approach e.g. not being able to do things like "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"INSERT INTO SELECT"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Storage"}]},{"type":"text","value":". Everything from the length of the key, to what it consists of, to how you store it in the database e.g. as an integer, a string, as binary etc."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now we know what to look for, let’s examine some options. I’m only going to cover a few because (as you’d discover from research) there are only so many ways you can generate a string of characters. In other words, many of the different algorithms are really just variations on a theme."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"uuids-aka-the-gold-standard"},"children":[{"type":"text","value":"UUIDS aka the gold standard"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"These are the granddaddy of unique keys. The acronym stands for universally unique identifier, which is quite frankly absurd. How can we possibly know it is unique in the universe? Microsoft opted to call it GUID, which is a globally unique identifier. That makes much more sense, but for whatever reason, outside of Microsoft (and its products), UUID is the term that stuck."}]},{"type":"element","tag":"h5","props":{"id":"so-what-is-it"},"children":[{"type":"text","value":"So, what is it?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"A UUID is a 128 bit string of alphanumeric characters broken up by dashes to make it readable. 128 bits translates to 32 characters, so it looks like this:"}]},{"type":"element","tag":"code","props":{"code":"123e4567-e89b-12d3-a456-426614174000\n","language":"shell"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"123e4567-e89b-12d3-a456-426614174000\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Simple enough, right? Well no. There are actually 5 different ways of creating a UUID. Seriously? But wait, it gets better!"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Draft proposals exist for creating versions 6, 7 and 8. If you’re reading this and thinking to yourself, “how can there possibly need to be 8 different ways to create a string of characters?”, then I’m definitely with you."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I’m not going to go into the different algorithms used to generate the versions. All I’ll say is that if you want a truly random UUID, then you need to use V4."}]},{"type":"element","tag":"h5","props":{"id":"how-do-i-create-them"},"children":[{"type":"text","value":"How do I create them?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There are countless libraries available for every programming language you can probably think of. Further, many databases include native functions for generating them (you’ll need to check which versions they generate though)."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"ulids"},"children":[{"type":"text","value":"ULIDS"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This stands for universally unique lexicographically sortable identifier. It aims to improve on the current UUID formats by offering shorter, sortable keys."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"ULIDs are 26 characters in length and use a format that includes a timestamp at the beginning (which makes them sortable). A ULID looks like this:"}]},{"type":"element","tag":"code","props":{"code":"01ARZ3NDEKTSV4RRFFQ69G5FAV\n","language":"shell"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"01ARZ3NDEKTSV4RRFFQ69G5FAV\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"ULIDs also include some other features, which make it more attractive than UUIDs such as case insensitivity, base32, and so on."}]},{"type":"element","tag":"h5","props":{"id":"how-do-i-create-them-1"},"children":[{"type":"text","value":"How do I create them?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The Github repo containing the specification for the format also maintains a list of implementations in different programming languages (the default is JavaScript, which makes it ideal for a lot of applications)."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"snowflakes"},"children":[{"type":"text","value":"Snowflakes"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This way of generating keys was developed by Twitter for their own systems and it has since been adopted by other big tech companies."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Unlike UUIDs and ULIDs, snowflake IDs only consist of numbers. In addition, they are the shortest at just 16 characters. A snowflake looks like this:"}]},{"type":"element","tag":"code","props":{"code":"3398978255192064\n","language":"shell"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"3398978255192064\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Snowflake identifiers also have the benefit of starting with a timestamp, which makes them sortable."}]},{"type":"element","tag":"h5","props":{"id":"how-do-i-create-them-2"},"children":[{"type":"text","value":"How do I create them?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Twitter have archived the open-source repository containing the source code for their original implementation. It appears to have now been folded into their Twitter server project. However, many separate implementations exist for most of the major programming languages."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"which-should-we-use"},"children":[{"type":"text","value":"Which should we use?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The short answer is, it depends. Each method has benefits, whether it is ease-of-use, library availability, overall familiarity, performance, efficiency, the need to work with data already in a similar format, etc."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Since there is no “correct” way as such, I’ll explain which of them I chose and why I did. To do that, I’ll go back to the checklist I wrote earlier in the article:"}]},{"type":"element","tag":"h5","props":{"id":"uniqueness"},"children":[{"type":"text","value":"Uniqueness"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Each of the three implementations claims to handle this well, with all of them being able to generate thousands of keys per millisecond without collision. So in truth, this isn’t really a factor when choosing one over the others."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There are some limits when it comes to the maximum number of keys you can create, but these are way off in the future e.g. the year 2060 or more, and it is somewhat unlikely any system built today will still be in operation then, or at the very least, won’t have been significantly changed in the preceding years."}]},{"type":"element","tag":"h5","props":{"id":"lexicography"},"children":[{"type":"text","value":"Lexicography"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Certain implementations of UUID are sortable (versions 1 and 2), however since these versions depend on MAC addresses, they tend not to be used due to potential security risks. You’ll also find variations of version 4, which have reordered the key so that the timestamp is first, this makes it sortable, but concerns have been raised about collision / randomness as a result."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"ULIDs were always designed to be sortable by beginning with timestamps. The same is also true of Snowflakes."}]},{"type":"element","tag":"h5","props":{"id":"efficiency"},"children":[{"type":"text","value":"Efficiency"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This one should be fairly obvious. Since UUIDs have the longest length, they take the longest to generate, followed by ULIDs, and then Snowflakes. I did some superficial benchmarks to see what the difference was and the results were quite striking. They might not seem like much, but at scale, when you need to generate thousands of records a second, it really adds up:"}]},{"type":"element","tag":"code","props":{"code":"Standard UUID v4 - 5.6 milliseconds\nSortable UUID v4 - 8.3 milliseconds\nULID             - 3.1 milliseconds\nSnowflake        - 0.4 milliseconds\n","language":"shell"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"Standard UUID v4 - 5.6 milliseconds\nSortable UUID v4 - 8.3 milliseconds\nULID             - 3.1 milliseconds\nSnowflake        - 0.4 milliseconds\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In addition, since the primary keys will also serve as foreign keys, queries that use them as part of a join will be significantly faster if they are integers. Put simply, integers are better than strings in every metric and in any scenario."}]},{"type":"element","tag":"h5","props":{"id":"storage"},"children":[{"type":"text","value":"Storage"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Like efficiency, UUID takes up the most space, followed by ULID, and then Snowflake. It should also be noted that indexing of strings takes up a lot more space and is less efficient than indexing of integers."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For example, a 100,000 record index involving integer primary keys is a couple of megabytes, but for strings it can jump to several hundred. You can make this more efficient by converting the strings to binary, but then your app has to handle converting to and from binary which is cumbersome."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Finally, I seeded a test database of 100,000 users and several million records per ancillary table. With Snowflake IDs, the DB was roughly 2.7 GB. When using strings (UUID or ULID), it was around 6.2 GB."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This might not seem like much, but the smaller the DB is, the more of it you can fit into memory, resulting in much better performance."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"conclusion"},"children":[{"type":"text","value":"Conclusion"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Of the three options, Snowflake is the clear winner. First, it is the shortest, which means it uses less space. It also begins with a timestamp, which makes it sortable. Finally, since it is an integer, it can be indexed faster, and queries that use it in joins will also be measurably faster."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Another added benefit, is that even though Snowflake uses integers, it does not use simple auto-incrementation, which means it is impossible to guess how many records are in the database table. While this is security through obscurity, it is a nice little cherry to have on the cake."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"wrapping-up"},"children":[{"type":"text","value":"Wrapping Up"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I hope you enjoyed this article and that you found something interesting in it. If you’d like to see more from me, then you can follow me on Twitter."}]}]},"date":"10th January 2022","image":{"src":"/images/articles/4.choosing-the-right-data-type-means-of-generating-unique-primary-keys.jpg"},"head":{"meta":[{"property":"og:title","content":"Choosing the right data type & means of generating unique primary keys"},{"property":"og:description","content":"I've been taking some time to investigate the options for how to safely generate unique primary keys for database records. Most of the time, as a developer, you probably won't need to think about this topic, but for those that do, this article is for you."}]},"body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"choosing-the-right-data-type--means-of-generating-unique-primary-keys"},"children":[{"type":"text","value":"Choosing the right data type & means of generating unique primary keys"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"span","props":{"className":["meta"]},"children":[{"type":"text","value":"10th January 2022"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"While building Lumeno, I've been taking some time to investigate the options for how to safely generate unique primary keys for database records. Most of the time, as a developer, you probably won't need to think about this topic, but for those that do, this article is for you."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"the-voice-of-reason"},"children":[{"type":"text","value":"The voice of reason"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Before we dig into the meat of this topic, it is worth pointing out that I’ve seen quite a few developers assume that they need to use a more complex system in order to generate unique identifiers for their primary keys."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If you’re building a system that is enterprise in nature, or you’re familiar with and need to use features like clusters, regions, replicas, and so on, then this is probably true. However, most of the time, developers are building modest applications powered by databases running on a single, modest server."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If this is you, then the default method of generating unique primary keys (auto-incrementing integers), should serve you just fine. Indeed, there are significant benefits to sticking with them…"}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"auto-incrementing-integers"},"children":[{"type":"text","value":"Auto-incrementing integers"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If you’re at least somewhat familiar with databases, then you’ll know that this is the standard way of generating unique keys. Behind the scenes, the system maintains an internal counter. When you insert a record, it increments the counter and sets the new record’s primary key to that value."}]},{"type":"element","tag":"h5","props":{"id":"is-this-a-good-approach"},"children":[{"type":"text","value":"Is this a good approach?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In short, yes! While there is a slight overhead in maintaining the counter, in practice it’s negligible. On the plus side, your records will always be unique, easily-indexed and super fast (in fact, its always the fastest option)."}]},{"type":"element","tag":"h5","props":{"id":"when-should-i-opt-for-the-something-different"},"children":[{"type":"text","value":"When should I opt for the something different?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I’ve already mentioned a few scenarios when you might want to consider something different, but even in those cases, you should ask yourself if you can still stick with incrementing integers. Sometimes, simply adjusting your schema to use a larger data type e.g. "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"BIG INT"}]},{"type":"text","value":", is enough."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Even if it’s not such a minimal adjustment, in a lot of cases, if you design your application and database correctly, then you can still use them."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"However, if you find you are making too many compromises, your app is becoming unwieldy, or your setup makes it too complex to use a database counter, then it may be time to reach for something else…"}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"alternatives-its-a-jungle-out-there"},"children":[{"type":"text","value":"Alternatives... it’s a jungle out there"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Okay, so you’ve decided that auto-incrementing integers are not for you. What do you use instead? Well, if you consult your database manual, you probably won’t get much help. Databases provide a default method. If you don’t want to use it, then you’re largely on your own. So, you go to the internet…"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Congratulations! You’ve discovered endless different ways of generating a unique string of characters to use as a primary key and you come away with no clear understanding of which one to use. Fortunately, when it comes to a database at least, choosing one really depends on just four things:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Uniqueness"}]},{"type":"text","value":". Every method of generating a key has a possibility of causing a collision (two generated keys being the same). Therefore, you want to choose a method with as low a risk of collision as possible."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Lexicography"}]},{"type":"text","value":". A complicated-sounding word that basically refers to some means of organization. In the database, we’re talking about being able to order our records using the key."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Efficiency"}]},{"type":"text","value":". Depending on the method you choose, your database might already include a function to generate a key using the algorithm. However, even if it does, it may be better to generate it within your app so the DB has less to do. Note that there are tradeoffs with this approach e.g. not being able to do things like "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"INSERT INTO SELECT"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Storage"}]},{"type":"text","value":". Everything from the length of the key, to what it consists of, to how you store it in the database e.g. as an integer, a string, as binary etc."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now we know what to look for, let’s examine some options. I’m only going to cover a few because (as you’d discover from research) there are only so many ways you can generate a string of characters. In other words, many of the different algorithms are really just variations on a theme."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"uuids-aka-the-gold-standard"},"children":[{"type":"text","value":"UUIDS aka the gold standard"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"These are the granddaddy of unique keys. The acronym stands for universally unique identifier, which is quite frankly absurd. How can we possibly know it is unique in the universe? Microsoft opted to call it GUID, which is a globally unique identifier. That makes much more sense, but for whatever reason, outside of Microsoft (and its products), UUID is the term that stuck."}]},{"type":"element","tag":"h5","props":{"id":"so-what-is-it"},"children":[{"type":"text","value":"So, what is it?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"A UUID is a 128 bit string of alphanumeric characters broken up by dashes to make it readable. 128 bits translates to 32 characters, so it looks like this:"}]},{"type":"element","tag":"code","props":{"code":"123e4567-e89b-12d3-a456-426614174000\n","language":"shell"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-fecb4b"},"children":[{"type":"text","value":"123e4567-e89b-12d3-a456-426614174000"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Simple enough, right? Well no. There are actually 5 different ways of creating a UUID. Seriously? But wait, it gets better!"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Draft proposals exist for creating versions 6, 7 and 8. If you’re reading this and thinking to yourself, “how can there possibly need to be 8 different ways to create a string of characters?”, then I’m definitely with you."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I’m not going to go into the different algorithms used to generate the versions. All I’ll say is that if you want a truly random UUID, then you need to use V4."}]},{"type":"element","tag":"h5","props":{"id":"how-do-i-create-them"},"children":[{"type":"text","value":"How do I create them?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There are countless libraries available for every programming language you can probably think of. Further, many databases include native functions for generating them (you’ll need to check which versions they generate though)."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"ulids"},"children":[{"type":"text","value":"ULIDS"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This stands for universally unique lexicographically sortable identifier. It aims to improve on the current UUID formats by offering shorter, sortable keys."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"ULIDs are 26 characters in length and use a format that includes a timestamp at the beginning (which makes them sortable). A ULID looks like this:"}]},{"type":"element","tag":"code","props":{"code":"01ARZ3NDEKTSV4RRFFQ69G5FAV\n","language":"shell"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-fecb4b"},"children":[{"type":"text","value":"01ARZ3NDEKTSV4RRFFQ69G5FAV"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"ULIDs also include some other features, which make it more attractive than UUIDs such as case insensitivity, base32, and so on."}]},{"type":"element","tag":"h5","props":{"id":"how-do-i-create-them-1"},"children":[{"type":"text","value":"How do I create them?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The Github repo containing the specification for the format also maintains a list of implementations in different programming languages (the default is JavaScript, which makes it ideal for a lot of applications)."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"snowflakes"},"children":[{"type":"text","value":"Snowflakes"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This way of generating keys was developed by Twitter for their own systems and it has since been adopted by other big tech companies."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Unlike UUIDs and ULIDs, snowflake IDs only consist of numbers. In addition, they are the shortest at just 16 characters. A snowflake looks like this:"}]},{"type":"element","tag":"code","props":{"code":"3398978255192064\n","language":"shell"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-fecb4b"},"children":[{"type":"text","value":"3398978255192064"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Snowflake identifiers also have the benefit of starting with a timestamp, which makes them sortable."}]},{"type":"element","tag":"h5","props":{"id":"how-do-i-create-them-2"},"children":[{"type":"text","value":"How do I create them?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Twitter have archived the open-source repository containing the source code for their original implementation. It appears to have now been folded into their Twitter server project. However, many separate implementations exist for most of the major programming languages."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"which-should-we-use"},"children":[{"type":"text","value":"Which should we use?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The short answer is, it depends. Each method has benefits, whether it is ease-of-use, library availability, overall familiarity, performance, efficiency, the need to work with data already in a similar format, etc."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Since there is no “correct” way as such, I’ll explain which of them I chose and why I did. To do that, I’ll go back to the checklist I wrote earlier in the article:"}]},{"type":"element","tag":"h5","props":{"id":"uniqueness"},"children":[{"type":"text","value":"Uniqueness"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Each of the three implementations claims to handle this well, with all of them being able to generate thousands of keys per millisecond without collision. So in truth, this isn’t really a factor when choosing one over the others."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There are some limits when it comes to the maximum number of keys you can create, but these are way off in the future e.g. the year 2060 or more, and it is somewhat unlikely any system built today will still be in operation then, or at the very least, won’t have been significantly changed in the preceding years."}]},{"type":"element","tag":"h5","props":{"id":"lexicography"},"children":[{"type":"text","value":"Lexicography"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Certain implementations of UUID are sortable (versions 1 and 2), however since these versions depend on MAC addresses, they tend not to be used due to potential security risks. You’ll also find variations of version 4, which have reordered the key so that the timestamp is first, this makes it sortable, but concerns have been raised about collision / randomness as a result."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"ULIDs were always designed to be sortable by beginning with timestamps. The same is also true of Snowflakes."}]},{"type":"element","tag":"h5","props":{"id":"efficiency"},"children":[{"type":"text","value":"Efficiency"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This one should be fairly obvious. Since UUIDs have the longest length, they take the longest to generate, followed by ULIDs, and then Snowflakes. I did some superficial benchmarks to see what the difference was and the results were quite striking. They might not seem like much, but at scale, when you need to generate thousands of records a second, it really adds up:"}]},{"type":"element","tag":"code","props":{"code":"Standard UUID v4 - 5.6 milliseconds\nSortable UUID v4 - 8.3 milliseconds\nULID             - 3.1 milliseconds\nSnowflake        - 0.4 milliseconds\n","language":"shell"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-fecb4b"},"children":[{"type":"text","value":"Standard UUID v4 - 5.6 milliseconds"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-fecb4b"},"children":[{"type":"text","value":"Sortable UUID v4 - 8.3 milliseconds"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-fecb4b"},"children":[{"type":"text","value":"ULID             - 3.1 milliseconds"}]}]},{"type":"element","tag":"span","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-fecb4b"},"children":[{"type":"text","value":"Snowflake        - 0.4 milliseconds"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In addition, since the primary keys will also serve as foreign keys, queries that use them as part of a join will be significantly faster if they are integers. Put simply, integers are better than strings in every metric and in any scenario."}]},{"type":"element","tag":"h5","props":{"id":"storage"},"children":[{"type":"text","value":"Storage"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Like efficiency, UUID takes up the most space, followed by ULID, and then Snowflake. It should also be noted that indexing of strings takes up a lot more space and is less efficient than indexing of integers."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For example, a 100,000 record index involving integer primary keys is a couple of megabytes, but for strings it can jump to several hundred. You can make this more efficient by converting the strings to binary, but then your app has to handle converting to and from binary which is cumbersome."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Finally, I seeded a test database of 100,000 users and several million records per ancillary table. With Snowflake IDs, the DB was roughly 2.7 GB. When using strings (UUID or ULID), it was around 6.2 GB."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This might not seem like much, but the smaller the DB is, the more of it you can fit into memory, resulting in much better performance."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"conclusion"},"children":[{"type":"text","value":"Conclusion"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Of the three options, Snowflake is the clear winner. First, it is the shortest, which means it uses less space. It also begins with a timestamp, which makes it sortable. Finally, since it is an integer, it can be indexed faster, and queries that use it in joins will also be measurably faster."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Another added benefit, is that even though Snowflake uses integers, it does not use simple auto-incrementation, which means it is impossible to guess how many records are in the database table. While this is security through obscurity, it is a nice little cherry to have on the cake."}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"wrapping-up"},"children":[{"type":"text","value":"Wrapping Up"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I hope you enjoyed this article and that you found something interesting in it. If you’d like to see more from me, then you can follow me on Twitter."}]},{"type":"element","tag":"style","children":[{"type":"text","value":".ct-fecb4b{color:#24292F}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"the-voice-of-reason","depth":3,"text":"The voice of reason"},{"id":"auto-incrementing-integers","depth":3,"text":"Auto-incrementing integers"},{"id":"alternatives-its-a-jungle-out-there","depth":3,"text":"Alternatives... it’s a jungle out there"},{"id":"uuids-aka-the-gold-standard","depth":3,"text":"UUIDS aka the gold standard"},{"id":"ulids","depth":3,"text":"ULIDS"},{"id":"snowflakes","depth":3,"text":"Snowflakes"},{"id":"which-should-we-use","depth":3,"text":"Which should we use?"},{"id":"conclusion","depth":3,"text":"Conclusion"},{"id":"wrapping-up","depth":3,"text":"Wrapping Up"}]}},"_type":"markdown","_id":"content:articles:4.choosing-the-right-data-type-means-of-generating-unique-primary-keys.md","_source":"content","_file":"articles/4.choosing-the-right-data-type-means-of-generating-unique-primary-keys.md","_extension":"md"}],"navigation":[{"title":"Articles","_path":"/articles","children":[{"title":"Articles - Thoughts on a browser's 'back' button","_path":"/articles/thoughts-on-a-browsers-back-button"},{"title":"Articles - Maintain statistics about your database tables using Laravel and triggers","_path":"/articles/maintain-statistics-about-your-database-tables-using-laravel-and-triggers"},{"title":"Articles - Using Twitter Snowflake IDs for your database primary keys in Laravel","_path":"/articles/using-twitter-snowflake-ids-for-your-database-primary-keys-in-laravel"},{"title":"Articles - Choosing the right data type & means of generating unique primary keys","_path":"/articles/choosing-the-right-data-type-means-of-generating-unique-primary-keys"}]}]}