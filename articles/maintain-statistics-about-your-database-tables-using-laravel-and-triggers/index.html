<!DOCTYPE html>
<html >
<head><meta charset="utf-8">
<title>Caneara - Articles - Maintain statistics about your database tables using Laravel and triggers</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:creator" content="@mattkingshott">
<meta name="twitter:site" content="@mattkingshott">
<link rel="icon" type="image/png" href="/images/logo.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.js"></script>
<meta property="og:title" content="Maintain statistics about your database tables using Laravel and triggers">
<meta property="og:description" content="A couple of weeks ago, I was tackling an issue with a database query that wasn’t performing very well. While indexing helped, having to count millions of records is always going to be slow. I therefore decided to use another approach.">
<meta name="description" content="A couple of weeks ago, I was tackling an issue with a database query that wasn’t performing very well. While indexing helped, having to count millions of records is always going to be slow. I therefore decided to use another approach.">
<meta property="og:image" content="/assets/images/2.setting-up-an-s3-bucket-and-cloudfront-distribution-for-a-laravel-vapor-storage-disk.jpg"><link rel="modulepreload" href="/articles/maintain-statistics-about-your-database-tables-using-laravel-and-triggers/_payload.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/entry.40f33138.js"><link rel="preload" as="style" href="/_nuxt/entry.197db9bc.css"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/_...slug_.52d2371a.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ContentDoc.37736983.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ContentRenderer.c3cb712e.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ContentRendererMarkdown.354e1803.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/_commonjsHelpers.fed2a411.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ContentQuery.4e1ce404.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/asyncData.17c5521a.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/utils.d3237ef2.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseH1.d3613abc.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseP.d83530c8.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseHr.53c38fdd.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseH3.8d4f2937.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseCodeInline.8e30aeed.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseOl.1a774c56.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseLi.1722c4e4.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseA.1008c181.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseCode.44373b82.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/web-socket.6d205850.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/error-component.969fe7fa.js"><link rel="stylesheet" href="/_nuxt/entry.197db9bc.css"><style>pre code .line{display:block;min-height:1rem}</style></head>
<body ><div id="__nuxt"><main class="font-sans leading-none flex flex-col min-h-screen"><header class="bg-cyan-900"><div class="container flex justify-center items-center py-4"><a href="/" class="font-medium text-12px text-gray-300 hover:text-white tracking-wider uppercase mr-10px md:mr-6"> About </a><a href="/projects" class="font-medium text-12px text-gray-300 hover:text-white tracking-wider uppercase mx-10px md:mx-6"> Projects </a><img alt="Logo" src="/vectors/logo.svg" class="h-24px md:h-[34px] mx-3 md:mx-6"><a href="/articles" class="font-medium text-12px text-gray-300 hover:text-white tracking-wider uppercase mx-10px md:mx-6"> Articles </a><span class="font-medium text-12px text-gray-300 hover:text-white tracking-wider uppercase cursor-pointer transition duration-300 ml-10px md:ml-6"> Contact </span></div></header><article class="flex flex-col items-center flex-1 p-6 md:p-0 mb-6 md:my-14 lg:my-20"><div class="w-full max-w-700px flex-1"><!--[--><!--[--><div class="markdown"><h1 id="maintain-statistics-about-your-database-tables-using-laravel-and-triggers"><!--[-->Maintain statistics about your database tables using Laravel and triggers<!--]--></h1><p><!--[--><span class="meta">8th February 2022</span><!--]--></p><p><!--[-->A couple of weeks ago, I was tackling an issue with a database query that wasn’t performing very well. The problem stemmed from attempting to do a count on a large number of records. While indexing helped, having to count millions of records is always going to be slow. I therefore decided that using a statistics table and maintaining the current count would be a better approach.<!--]--></p><hr><h3 id="getting-started"><a href="#getting-started"><!--[-->Getting started<!--]--></a></h3><p><!--[-->As you might expect within a Laravel application, I first created a <code><!--[-->statistics<!--]--></code> table that had a table <code><!--[-->name<!--]--></code> column and a <code><!--[-->JSON<!--]--></code> values column. Next, I had to write the code to create statistic records and maintain them.<!--]--></p><p><!--[-->One approach for this, is to use model events. These are fired automatically by Laravel when a model is created, deleted etc. However, while they are very powerful and definitely have their uses, there are some major drawbacks to trying to maintain statistics by using them:<!--]--></p><ol><!--[--><li><!--[-->Model events are only fired on model instances. So, if you run a database query to, say mass-delete some records, then no events will be fired.<!--]--></li><li><!--[-->Maintaining statistics within your app means that any database activity MUST go through your app. If you delete a record using a tool like TablePlus or Sequel Ace, then your stats won’t get updated.<!--]--></li><!--]--></ol><hr><h3 id="triggers-to-the-rescue"><a href="#triggers-to-the-rescue"><!--[-->Triggers to the rescue<!--]--></a></h3><p><!--[-->Database triggers are a lot like model events, except they are physically wired into the database itself, which means that they are fired no matter what app, tool or person is responsible for altering the database state (whether it is one record you’re working with or one thousand).<!--]--></p><p><!--[-->Of course, since they are part of the database itself, the code statements that they execute must be pure SQL. This can make for a less than ideal developer experience, particularly if you’re not great when it comes to writing SQL, but for what I wanted to do, I knew it wouldn’t be too complicated.<!--]--></p><hr><h3 id="adding-trigger-support-to-laravel"><a href="#adding-trigger-support-to-laravel"><!--[-->Adding trigger support to Laravel<!--]--></a></h3><p><!--[-->Out of the box, triggers are not supported in Laravel, so I had to first build a package that would allow me to easily add triggers to any table I wanted. This package is <a href="https://github.com/caneara/triggers" rel="nofollow"><!--[-->available here<!--]--></a> and includes full documentation.<!--]--></p><p><!--[-->If you’ve worked with model events before (or used <code><!--[-->Observer<!--]--></code> classes), then it should feel extremely familiar. The only downside, as mentioned above, is that you need to write raw SQL to make them work. As Laravel developers, we like to abstract such logic behind a friendly API...<!--]--></p><hr><h3 id="easily-add-and-maintain-statistics"><a href="#easily-add-and-maintain-statistics"><!--[-->Easily add and maintain statistics<!--]--></a></h3><p><!--[-->Now that triggers can be added, and I have my statistics table, all I needed to do was add some helpful methods to create the triggers and aggregate column values. Given that triggers require their database table to already exist, I think it makes sense to start the statistic creation process from the Model class e.g.<!--]--></p><!--[--><pre><code><span class="line"><span class="ct-40c1bf">Article</span><span class="ct-9a98b7">::</span><span class="ct-f11b3e">track</span><span class="ct-8bb1d9">()</span></span></code></pre><!--]--><p><!--[-->Next, we want to be able to maintain the statistics themselves. We’ll therefore need methods that correspond to SQL aggregation methods e.g. <code><!--[-->COUNT<!--]--></code>, <code><!--[-->MAX<!--]--></code>, <code><!--[-->MIN<!--]--></code>, <code><!--[-->SUM<!--]--></code>, <code><!--[-->AVG<!--]--></code>:<!--]--></p><!--[--><pre><code><span class="line"><span class="ct-40c1bf">Article</span><span class="ct-9a98b7">::</span><span class="ct-f11b3e">track</span><span class="ct-8bb1d9">()</span></span><span class="line"><span class="ct-8bb1d9">    </span><span class="ct-9a98b7">-&gt;</span><span class="ct-f11b3e">count</span><span class="ct-8bb1d9">()      </span><span class="ct-ef6827">// Count all records</span></span><span class="line"><span class="ct-8bb1d9">    </span><span class="ct-9a98b7">-&gt;</span><span class="ct-f11b3e">sum</span><span class="ct-8bb1d9">(</span><span class="ct-a1ef7f">&#39;likes&#39;</span><span class="ct-8bb1d9">) </span><span class="ct-ef6827">// Get the sum of the &#39;likes&#39; column</span></span></code></pre><!--]--><p><!--[-->Finally, we just need to instruct Laravel to go ahead and create an empty statistic record, as well as install the triggers:<!--]--></p><!--[--><pre><code><span class="line"><span class="ct-40c1bf">Article</span><span class="ct-9a98b7">::</span><span class="ct-f11b3e">track</span><span class="ct-8bb1d9">()</span></span><span class="line"><span class="ct-8bb1d9">    </span><span class="ct-9a98b7">-&gt;</span><span class="ct-f11b3e">count</span><span class="ct-8bb1d9">()</span></span><span class="line"><span class="ct-8bb1d9">    </span><span class="ct-9a98b7">-&gt;</span><span class="ct-f11b3e">sum</span><span class="ct-8bb1d9">(</span><span class="ct-a1ef7f">&#39;likes&#39;</span><span class="ct-8bb1d9">)</span></span><span class="line"><span class="ct-8bb1d9">    </span><span class="ct-9a98b7">-&gt;</span><span class="ct-f11b3e">create</span><span class="ct-8bb1d9">()</span></span></code></pre><!--]--><p><!--[-->And that’s all there is to it. Accurate aggregations that are constantly kept in sync without any ongoing application logic being needed!<!--]--></p><p><!--[-->You can starting using <a href="https://github.com/caneara/statistics" rel="nofollow"><!--[-->this package<!--]--></a> right away in your own apps and it also includes further documentation to explain how it works.<!--]--></p><p><!--[-->When you’re ready to start adding further triggers, e.g. for maintaining statistics on individual records (<code><!--[-->article -&gt; likes, views, comments<!--]--></code> etc.) why not dive into the source to see how its done.<!--]--></p><hr><h3 id="wrapping-up"><a href="#wrapping-up"><!--[-->Wrapping Up<!--]--></a></h3><p><!--[-->I hope you enjoyed this article and that you found something interesting in it. If you’d like to see more from me, then you can follow me on Twitter.<!--]--></p><style>.ct-a1ef7f{color:#0A3069}.ct-ef6827{color:#6E7781}.ct-8bb1d9{color:#24292F}.ct-f11b3e{color:#8250DF}.ct-9a98b7{color:#CF222E}.ct-40c1bf{color:#0550AE}</style></div><!--]--><!--]--></div></article><footer class="text-11px text-gray-400/80 tracking-wide flex justify-center mb-6 md:mb-12"> © 2022 Caneara. All rights reserved. </footer></main></div><script type="module">import p from "/articles/maintain-statistics-about-your-database-tables-using-laravel-and-triggers/_payload.js";window.__NUXT__={...p,...((function(a,b){return {state:{},_errors:{},serverRendered:true,config:{public:{content:{clientDB:{isSPA:a,integrity:1669889824217},navigation:{fields:[]},base:"_content",tags:{p:"prose-p",a:"prose-a",blockquote:"prose-blockquote","code-inline":"prose-code-inline",code:"prose-code",em:"prose-em",h1:"prose-h1",h2:"prose-h2",h3:"prose-h3",h4:"prose-h4",h5:"prose-h5",h6:"prose-h6",hr:"prose-hr",img:"prose-img",ul:"prose-ul",ol:"prose-ol",li:"prose-li",strong:"prose-strong",table:"prose-table",thead:"prose-thead",tbody:"prose-tbody",td:"prose-td",th:"prose-th",tr:"prose-tr"},highlight:{theme:"github-light",preload:["diff","json","js","ts","css","shell","html","md","yaml","php"],apiURL:"\u002Fapi\u002F_content\u002Fhighlight"},wsUrl:b,documentDriven:a,anchorLinks:{depth:4,exclude:[1]}}},app:{baseURL:"\u002F",buildAssetsDir:"\u002F_nuxt\u002F",cdnURL:b}},prerenderedAt:1669889839538}}(false,"")))}</script><script type="module" src="/_nuxt/entry.40f33138.js" crossorigin></script><script type="module" src="/_nuxt/_...slug_.52d2371a.js" crossorigin></script><script type="module" src="/_nuxt/ContentDoc.37736983.js" crossorigin></script><script type="module" src="/_nuxt/ContentRenderer.c3cb712e.js" crossorigin></script><script type="module" src="/_nuxt/ContentRendererMarkdown.354e1803.js" crossorigin></script><script type="module" src="/_nuxt/ProseH1.d3613abc.js" crossorigin></script><script type="module" src="/_nuxt/ProseP.d83530c8.js" crossorigin></script><script type="module" src="/_nuxt/ProseHr.53c38fdd.js" crossorigin></script><script type="module" src="/_nuxt/ProseH3.8d4f2937.js" crossorigin></script><script type="module" src="/_nuxt/ProseCodeInline.8e30aeed.js" crossorigin></script><script type="module" src="/_nuxt/ProseOl.1a774c56.js" crossorigin></script><script type="module" src="/_nuxt/ProseLi.1722c4e4.js" crossorigin></script><script type="module" src="/_nuxt/ProseA.1008c181.js" crossorigin></script><script type="module" src="/_nuxt/ProseCode.44373b82.js" crossorigin></script></body>
</html>